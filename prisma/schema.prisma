// Deke Sharon AI Agent Ecosystem - Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // Prisma 7: No url here - configured in prisma.config.ts for CLI and db.ts for runtime
}

// DATABASE_URL configuration:
// - CLI commands (migrate, db push): Use DIRECT_URL from prisma.config.ts
// - Runtime queries: Use DATABASE_URL via adapter in db.ts
// For Supabase:
//   DATABASE_URL: Transaction pooled mode (port 6543, pgbouncer=true)
//   DIRECT_URL: Direct session mode (port 5432, no pooling)

// ============================================
// LEADS & CONTACTS
// ============================================

model Lead {
  id            String    @id @default(cuid())
  firstName     String
  lastName      String
  email         String    @unique
  phone         String?
  organization  String?
  source        String?   // website, referral, social, etc.
  status        String    @default("NEW") // NEW, CONTACTED, QUALIFIED, PROPOSAL_SENT, NEGOTIATING, WON, LOST, DORMANT
  score         Int       @default(0)  // Lead scoring

  // Geographic coordinates for opportunity finder
  latitude      Float?
  longitude     Float?
  lastContactedAt DateTime?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  inquiries     Inquiry[]
  chatSessions  ChatSession[]
  bookings      Booking[]
  orders        Order[]
  campaignLeads CampaignLead[]

  @@index([email])
  @@index([status])
  @@index([latitude, longitude])
  @@index([lastContactedAt])
}

// Removed enum LeadStatus - now using String with validation comments

// ============================================
// TRIPS & TRAVEL MANAGEMENT
// ============================================

model Trip {
  id            String    @id @default(cuid())
  name          String    // e.g., "Montreal Weekend", "California Tour"
  location      String    // Primary city/region
  startDate     DateTime
  endDate       DateTime
  status        String    @default("upcoming") // upcoming, in-progress, completed, cancelled

  // Notes
  notes         String?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  bookings      Booking[]

  @@index([status])
  @@index([startDate])
}

// ============================================
// INQUIRIES & BOOKINGS
// ============================================

model Inquiry {
  id            String      @id @default(cuid())
  leadId        String
  lead          Lead        @relation(fields: [leadId], references: [id])
  serviceType   String      // ARRANGEMENT, GROUP_COACHING, INDIVIDUAL_COACHING, WORKSHOP, SPEAKING, MASTERCLASS, CONSULTATION
  status        String      @default("PENDING") // PENDING, QUOTED, ACCEPTED, DECLINED, EXPIRED

  // Service-specific details (JSON for flexibility)
  details       String?     // JSON string
  message       String?

  // Quote info (from MAESTRO agent)
  quotedAmount  Float?
  quotedAt      DateTime?
  quoteExpiry   DateTime?

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  booking       Booking?

  @@index([leadId])
  @@index([serviceType])
  @@index([status])
}

// Removed enum ServiceType - now using String with validation comments
// Removed enum InquiryStatus - now using String with validation comments

model Booking {
  id            String        @id @default(cuid())
  leadId        String
  lead          Lead          @relation(fields: [leadId], references: [id])
  inquiryId     String?       @unique
  inquiry       Inquiry?      @relation(fields: [inquiryId], references: [id])

  // Trip relation
  tripId        String?
  trip          Trip?         @relation(fields: [tripId], references: [id])

  serviceType   String        // ARRANGEMENT, GROUP_COACHING, INDIVIDUAL_COACHING, WORKSHOP, SPEAKING, MASTERCLASS, CONSULTATION
  status        String        @default("PENDING") // PENDING, CONFIRMED, IN_PROGRESS, COMPLETED, CANCELLED, RESCHEDULED

  // Scheduling
  startDate     DateTime?
  endDate       DateTime?
  timezone      String?
  location      String?       // Address or "Virtual"

  // Geographic coordinates for opportunity finder
  latitude      Float?
  longitude     Float?

  // Financials
  amount        Float?
  depositPaid   Float?
  balanceDue    Float?
  paymentStatus String        @default("UNPAID") // UNPAID, DEPOSIT_PAID, PAID_IN_FULL, REFUNDED, OVERDUE

  // Notes
  internalNotes String?
  clientNotes   String?

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // New relations for travel and group bookings
  travelExpenses    TravelExpense[]
  participants      BookingParticipant[]

  // New fields for group bookings
  isGroupBooking    Boolean  @default(false)
  totalServiceFee   Float?
  travelBudget      Float?
  splitMethod       String?  // EQUAL, BY_SIZE, CUSTOM, AUTO_OPTIMAL
  splitNotes        String?

  // Relations
  campaigns     Campaign[]

  @@index([leadId])
  @@index([tripId])
  @@index([status])
  @@index([startDate])
  @@index([latitude, longitude])
  @@index([status, startDate])
}

// Removed enum BookingStatus - now using String with validation comments
// Removed enum PaymentStatus - now using String with validation comments

model TravelExpense {
  id            String   @id @default(cuid())
  bookingId     String
  booking       Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  // Flight details
  flightCarrier     String?
  flightNumber      String?
  departureAirport  String?
  arrivalAirport    String?
  departureTime     DateTime?
  arrivalTime       DateTime?
  flightCost        Float?

  // Hotel details
  hotelName         String?
  hotelAddress      String?
  checkInDate       DateTime?
  checkOutDate      DateTime?
  confirmationNumber String?
  hotelCost         Float?

  // Ground transportation
  groundTransport   String?  // CAR_RENTAL, TAXI, UBER, OTHER
  groundTransportDetails String?
  groundTransportCost    Float?

  // Payment responsibility
  paymentResponsibility String @default("CLIENT") // CLIENT, DEKE, SPLIT
  clientPayPercent  Float?  // 0-100
  dekePayPercent    Float?  // 0-100

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([bookingId])
}

model BookingParticipant {
  id            String   @id @default(cuid())
  bookingId     String
  booking       Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  organizationName  String
  contactName       String?
  contactEmail      String?
  contactPhone      String?
  groupSize         Int?

  // Calculated split
  splitPercent      Float   @default(0)  // 0-100
  amountDue         Float   @default(0)
  travelShareDue    Float   @default(0)

  // Payment status
  paymentStatus     String  @default("PENDING")  // PENDING, PAID, PARTIAL, OVERDUE

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([bookingId])
}

// ============================================
// ARRANGEMENTS & ORDERS
// ============================================

model Order {
  id              String      @id @default(cuid())
  leadId          String
  lead            Lead        @relation(fields: [leadId], references: [id])
  orderNumber     String      @unique
  status          String      @default("PENDING") // PENDING, IN_PROGRESS, REVIEW, REVISION, COMPLETED, DELIVERED, CANCELLED

  // Arrangement details
  songTitle       String?
  songArtist      String?
  voiceParts      Int?
  packageTier     String?     // Essential, Professional, Premium

  // Pricing
  basePrice       Float?
  rushFee         Float?
  totalAmount     Float?

  // Delivery
  dueDate         DateTime?
  deliveredAt     DateTime?
  downloadUrl     String?

  // Revisions
  revisionsUsed   Int         @default(0)
  revisionsMax    Int         @default(1)

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([leadId])
  @@index([status])
  @@index([orderNumber])
}

// Removed enum OrderStatus - now using String with validation comments

// ============================================
// CHAT & CONVERSATIONS (HARMONY Agent)
// ============================================

model ChatSession {
  id          String    @id @default(cuid())
  leadId      String?
  lead        Lead?     @relation(fields: [leadId], references: [id])

  // Session metadata
  sessionId   String    @unique  // For anonymous tracking
  source      String?   // Page URL where chat started
  userAgent   String?
  ipAddress   String?

  // Status
  status      String     @default("ACTIVE") // ACTIVE, IDLE, ENDED, TRANSFERRED

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  endedAt     DateTime?

  messages    ChatMessage[]

  @@index([leadId])
  @@index([sessionId])
}

// Removed enum ChatStatus - now using String with validation comments

model ChatMessage {
  id            String      @id @default(cuid())
  sessionId     String
  session       ChatSession @relation(fields: [sessionId], references: [id])

  role          String      // user, assistant, system
  content       String

  // Agent tracking
  agentId       String?     // Which agent responded
  toolsUsed     String?     // JSON array of tools/actions taken

  createdAt     DateTime    @default(now())

  @@index([sessionId])
}

// ============================================
// CONTENT (SCRIBE Agent)
// ============================================

model ContentPiece {
  id            String        @id @default(cuid())
  type          String        // BLOG_POST, SOCIAL_POST, EMAIL, NEWSLETTER, VIDEO_SCRIPT, PODCAST_NOTES
  title         String
  content       String
  excerpt       String?

  // Metadata
  status        String        @default("DRAFT") // DRAFT, SCHEDULED, PUBLISHED, ARCHIVED
  publishedAt   DateTime?
  scheduledFor  DateTime?

  // SEO
  slug          String?       @unique
  metaTitle     String?
  metaDesc      String?

  // Social
  socialCopy    String?       // JSON string: { twitter, instagram, linkedin, etc. }

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([type])
  @@index([status])
  @@index([slug])
}

// Removed enum ContentType - now using String with validation comments
// Removed enum ContentStatus - now using String with validation comments

// ============================================
// ANALYTICS (METRICS Agent)
// ============================================

model AnalyticsEvent {
  id          String    @id @default(cuid())
  eventType   String    // page_view, chat_started, booking_completed, etc.
  eventData   String?   // JSON string

  // Context
  leadId      String?
  sessionId   String?
  source      String?

  createdAt   DateTime  @default(now())

  @@index([eventType])
  @@index([leadId])
  @@index([createdAt])
}

model RevenueMetric {
  id            String    @id @default(cuid())
  period        String    // YYYY-MM format
  serviceType   String    // ARRANGEMENT, GROUP_COACHING, INDIVIDUAL_COACHING, WORKSHOP, SPEAKING, MASTERCLASS, CONSULTATION

  // Metrics
  inquiries     Int       @default(0)
  bookings      Int       @default(0)
  revenue       Float     @default(0)
  conversionRate Float?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([period, serviceType])
  @@index([period])
}

// ============================================
// AGENT LOGS & MEMORY
// ============================================

model AgentLog {
  id          String    @id @default(cuid())
  agentId     String    // harmony, maestro, tempo, etc.
  actionType  String
  input       String?   // JSON string
  output      String?   // JSON string
  success     Boolean
  errorMsg    String?
  durationMs  Int?

  createdAt   DateTime  @default(now())

  @@index([agentId])
  @@index([actionType])
  @@index([createdAt])
}

model AgentMemory {
  id          String    @id @default(cuid())
  agentId     String
  memoryType  String    // preference, context, pattern
  key         String
  value       String    // JSON string
  importance  Int       @default(5)  // 1-10 scale

  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([agentId, key])
  @@index([agentId])
  @@index([memoryType])
}

// ============================================
// OPPORTUNITY FINDER - MVP v1.0
// ============================================

model Campaign {
  id            String         @id @default(cuid())
  name          String
  baseLocation  String         // e.g., "Los Angeles, CA"
  latitude      Float
  longitude     Float
  radius        Float          @default(100) // miles, default 100 per user request
  status        String         @default("DRAFT") // DRAFT, APPROVED, ACTIVE, PAUSED, COMPLETED, CANCELLED
  startDate     DateTime?
  endDate       DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  approvedAt    DateTime?
  launchedAt    DateTime?

  leads         CampaignLead[]
  outreachLogs  OutreachLog[]

  // Optional: Link to booking that triggered campaign
  booking       Booking?       @relation(fields: [bookingId], references: [id])
  bookingId     String?        @unique

  @@index([status])
  @@index([startDate])
  @@index([baseLocation])
}

// Removed enum CampaignStatus - now using String with validation comments

model CampaignLead {
  id            String              @id @default(cuid())
  campaign      Campaign            @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  campaignId    String
  lead          Lead                @relation(fields: [leadId], references: [id])
  leadId        String
  score         Int                 @default(50) // 0-100
  distance      Float               // miles from campaign base location
  source        String              // PAST_CLIENT, DORMANT, SIMILAR_ORG, AI_RESEARCH, MANUAL_IMPORT
  status        String              @default("PENDING") // PENDING, CONTACTED, OPENED, CLICKED, RESPONDED, BOOKED, DECLINED, REMOVED
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  // Phase 3: Service Recommendation Engine
  recommendedServices  String?  // JSON array of service types to pitch
  recommendationReason String?  // Why these services? (for template variables)
  recommendationScore  Int?     // 0-15 bonus from recommendations

  // Phase 6: Follow-up automation
  scheduledFollowUpDate  DateTime?  // When next follow-up should be sent
  followUpCount          Int        @default(0)  // How many follow-ups sent (0, 1, 2)
  followUpsPaused        Boolean    @default(false)  // Auto or manual pause
  followUpPauseReason    String?    // "clicked", "responded", "booked", "manual"
  followUpPausedAt       DateTime?  // When paused

  outreachLogs  OutreachLog[]

  @@unique([campaignId, leadId]) // prevent duplicates
  @@index([campaignId, status])
  @@index([score])
  @@index([scheduledFollowUpDate, followUpsPaused])  // For cron queries
}

// Removed enum LeadSource - now using String with validation comments
// Removed enum CampaignLeadStatus - now using String with validation comments

model OutreachLog {
  id              String          @id @default(cuid())
  campaignLead    CampaignLead    @relation(fields: [campaignLeadId], references: [id], onDelete: Cascade)
  campaignLeadId  String
  campaign        Campaign        @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  campaignId      String
  channel         String          // EMAIL, SMS, LINKEDIN
  status          String          @default("PENDING") // PENDING, SENT, DELIVERED, OPENED, CLICKED, RESPONDED, FAILED, BOUNCED
  sentAt          DateTime?
  openedAt        DateTime?
  clickedAt       DateTime?
  respondedAt     DateTime?
  errorMessage    String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([campaignLeadId, channel])
  @@index([campaignId, status])
  @@index([sentAt])
}

// Removed enum OutreachChannel - now using String with validation comments
// Removed enum OutreachStatus - now using String with validation comments

model GeoPreference {
  id            String   @id @default(cuid())
  country       String   @unique
  defaultRadius Float    // miles or km depending on country
  unit          String   // "miles" or "km"
  enabled       Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([country])
}

model MessageTemplate {
  id          String          @id @default(cuid())
  name        String
  serviceType String?         // ARRANGEMENT, GROUP_COACHING, INDIVIDUAL_COACHING, WORKSHOP, SPEAKING, MASTERCLASS, CONSULTATION
  subject     String?         // for emails
  body        String
  channel     String          @default("EMAIL") // EMAIL, SMS, LINKEDIN
  variables   String?         // JSON: ["firstName", "location", "dates", etc.]
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  // Phase 3: Service Recommendation Engine
  recommendationContext String?  // "upsell", "cross-sell", "org-specific"
  targetOrgTypes        String?  // JSON array of OrgType values

  @@index([serviceType, channel])
}

model Suppression {
  id        String   @id @default(cuid())
  email     String?  @unique
  phone     String?  @unique
  reason    String   // opt_out, bounce, complaint, manual
  source    String   // which campaign triggered suppression
  createdAt DateTime @default(now())

  @@index([email])
  @@index([phone])
}

// ============================================
// PHASE 3: SERVICE RECOMMENDATION ENGINE
// ============================================

// ============================================
// FIND A GROUP - Singer Matching Requests
// ============================================

model GroupRequest {
  id            String    @id @default(cuid())

  // Contact info
  name          String
  email         String
  location      String
  age           Int?

  // Preferences
  experience    String    // beginner, intermediate, advanced, professional
  commitment    String    // casual, regular, intensive, flexible
  genres        String[]  // Array of genre preferences
  performanceInterest Boolean @default(false)
  message       String?

  // Status tracking
  status        String    @default("PENDING") // PENDING, REVIEWING, MATCHED, CLOSED
  notes         String?   // Admin notes

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([email])
  @@index([status])
  @@index([location])
}

model ServiceRecommendation {
  id                String   @id @default(cuid())

  // Rule definition
  name              String   // "Workshop → Masterclass", "University → Group Coaching"
  triggerServiceType String?  // Service that triggers recommendation (null = org-based)
  recommendedService String  // Service to recommend

  // Organization targeting
  orgTypes          String?  // JSON array of OrgType values
  minOrgSize        Int?     // Minimum organization size
  maxOrgSize        Int?     // Maximum organization size

  // Recommendation strength
  weight            Float    @default(1.0) // 0.5-2.0, affects scoring
  priority          Int      @default(5)   // 1-10, higher = more important

  // Messaging
  messageTemplate   String?  // Custom message template ID
  pitchPoints       String?  // JSON array of key selling points

  // Metadata
  active            Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([triggerServiceType])
  @@index([recommendedService])
  @@index([active])
}
